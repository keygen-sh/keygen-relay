# add license to prod pool
exec relay add --pool prod --file license.lic --key 9E32DD-D8CC22-771926-C2D834-C506DC-V3 --public-key e8601e48b69383ba520245fd07971e983d06d22c4257cfd82304601479cee788

# add license to dev pool
exec relay add --pool dev --file license_2.lic --key 9A96B8-FD08CD-8C433B-7657C8-8A8655-V3 --public-key e8601e48b69383ba520245fd07971e983d06d22c4257cfd82304601479cee788

# set a port as environment variable
env PORT=65058

# start the server configured for prod pool only
exec relay serve --port $PORT --pool prod &server_process_test&

# wait for the server to start
exec sleep 1

# try to claim a license from dev pool using header (conflicts with server config)
exec curl -s -o response.txt -w "%{http_code}" -X PUT -H 'Relay-Pool: dev' http://localhost:$PORT/v1/nodes/test_fingerprint

# expect a bad request response with status code 400
stdout '400'

# check that the response contains error about unsupported pool header
exec grep '"error"' response.txt
exec grep 'unsupported pool header' response.txt

# verify we can claim from the configured pool (prod)
exec curl -s -o success_response.txt -w "%{http_code}" -X PUT -H 'Relay-Pool: prod' http://localhost:$PORT/v1/nodes/test_fingerprint
stdout '201'

# kill the process (stop the server)
kill server_process_test