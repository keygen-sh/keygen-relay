# add license to prod pool
exec relay add --pool prod --file license.lic --key 9E32DD-D8CC22-771926-C2D834-C506DC-V3 --public-key e8601e48b69383ba520245fd07971e983d06d22c4257cfd82304601479cee788

# add license to dev pool
exec relay add --pool dev --file license_2.lic --key 9A96B8-FD08CD-8C433B-7657C8-8A8655-V3 --public-key e8601e48b69383ba520245fd07971e983d06d22c4257cfd82304601479cee788

# set a port as environment variable
env PORT=65057

# start the server with heartbeat disabled
exec relay serve --port $PORT &server_process_test&

# wait for the server to start
exec sleep 1

# claim a license from prod pool
exec curl -s -o claim_response.txt -w "%{http_code}" -X PUT -H 'Relay-Pool: prod' http://localhost:$PORT/v1/nodes/test_fingerprint
stdout '201'

# try to release the license to dev pool (wrong pool)
exec curl -s -o response.txt -w "%{http_code}" -X DELETE -H 'Relay-Pool: dev' http://localhost:$PORT/v1/nodes/test_fingerprint

# expect a not found response with status code 404 (claim not found in that pool)
stdout '404'

# check that the response contains error about claim not found
exec grep '"error"' response.txt
exec grep 'claim not found' response.txt

# verify we can still release to the correct pool
exec curl -s -o correct_response.txt -w "%{http_code}" -X DELETE -H 'Relay-Pool: prod' http://localhost:$PORT/v1/nodes/test_fingerprint
stdout '204'

# kill the process (stop the server)
kill server_process_test