# add the license
exec relay add --file license.lic --key 9E32DD-D8CC22-771926-C2D834-C506DC-V3 --public-key e8601e48b69383ba520245fd07971e983d06d22c4257cfd82304601479cee788

# set a port as environment variable
env PORT=65041

# start the server without signing secret
exec relay serve --port $PORT &server_process_test_1&

# wait for the server to start
exec sleep 1

# claim a license
exec curl -s -D headers.txt -o /dev/null -w "%{http_code}" -X PUT http://localhost:$PORT/v1/nodes/test_fingerprint

# expect no signature header
stdout '201'
! exec grep 'Relay-Signature:' headers.txt

# kill the server
kill server_process_test_1

# restart the server with signing secret
env PORT=65042

exec relay serve --port $PORT --signing-secret hunter2 -vvvv &server_process_test_2&

# wait for the server to start
exec sleep 1

# claim a license
exec curl -s -D headers.txt -o /dev/null -w "%{http_code}" -X PUT http://localhost:$PORT/v1/nodes/test_fingerprint

# expect a signature header
stdout '202'
exec grep 'Relay-Signature:' headers.txt

# kill the server
kill server_process_test_2
